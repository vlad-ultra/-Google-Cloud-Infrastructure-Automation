name: üóëÔ∏è Destroy Infrastructure

on:
  workflow_dispatch:  # Manual trigger only
    inputs:
      confirm_destroy:
        description: '‚ö†Ô∏è  WARNING: This will destroy ALL infrastructure! Type DESTROY to confirm'
        required: true
        default: 'NO'
        type: string
      preserve_ips:
        description: 'Preserve static IP addresses (recommended)'
        required: true
        default: true
        type: boolean

jobs:
  destroy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Confirm destruction
      run: |
        if [ "${{ github.event.inputs.confirm_destroy }}" != "DESTROY" ]; then
          echo "‚ùå Destruction not confirmed. Please type 'DESTROY' to proceed."
          exit 1
        fi
        echo "‚ö†Ô∏è  DESTRUCTION CONFIRMED - This will destroy ALL infrastructure!"
        echo "üìã Preserve static IPs: ${{ github.event.inputs.preserve_ips }}"
      
    - name: Setup Google Cloud CLI
      uses: google-github-actions/setup-gcloud@v2
      with:
        service_account_key: ${{ secrets.GCP_SA_KEY }}
        project_id: ${{ secrets.GCP_PROJECT_ID }}
        export_default_credentials: true
        
    - name: Authenticate to Google Cloud
      run: |
        echo '${{ secrets.GCP_SA_KEY }}' > /tmp/gcp-key.json
        gcloud auth activate-service-account --key-file=/tmp/gcp-key.json
        gcloud config set project ${{ secrets.GCP_PROJECT_ID }}
        echo "GOOGLE_APPLICATION_CREDENTIALS=/tmp/gcp-key.json" >> $GITHUB_ENV
        
        
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.6.0
        
    - name: Check existing infrastructure
      run: |
        echo "üîç Checking for existing infrastructure..."
        
        # Check if instances exist
        if gcloud compute instances describe web1-prod --zone=europe-west1-b --quiet 2>/dev/null; then
          echo "‚úÖ Infrastructure found - proceeding with destruction"
          echo "INFRA_EXISTS=true" >> $GITHUB_ENV
        else
          echo "‚ö†Ô∏è  No infrastructure found - nothing to destroy"
          echo "INFRA_EXISTS=false" >> $GITHUB_ENV
        fi
        
    - name: Initialize Terraform
      if: env.INFRA_EXISTS == 'true'
      run: |
        cd infrastructure
        export GOOGLE_APPLICATION_CREDENTIALS=/tmp/gcp-key.json
        echo "üèóÔ∏è Initializing Terraform..."
        terraform init -upgrade
        
    - name: Import existing resources
      if: env.INFRA_EXISTS == 'true'
      run: |
        cd infrastructure
        export GOOGLE_APPLICATION_CREDENTIALS=/tmp/gcp-key.json
        echo "üîÑ Importing existing resources into Terraform state..."
        
        # Import instances if they exist
        if gcloud compute instances describe web1-prod --zone=europe-west1-b --quiet 2>/dev/null; then
          terraform import google_compute_instance.web1 projects/${{ secrets.GCP_PROJECT_ID }}/zones/europe-west1-b/instances/web1-prod || true
        fi
        
        if gcloud compute instances describe web2-prod --zone=europe-west1-b --quiet 2>/dev/null; then
          terraform import google_compute_instance.web2 projects/${{ secrets.GCP_PROJECT_ID }}/zones/europe-west1-b/instances/web2-prod || true
        fi
        
        if gcloud compute instances describe haproxy-prod --zone=europe-west1-b --quiet 2>/dev/null; then
          terraform import google_compute_instance.haproxy projects/${{ secrets.GCP_PROJECT_ID }}/zones/europe-west1-b/instances/haproxy-prod || true
        fi
        
        # Import firewall rules if they exist
        if gcloud compute firewall-rules describe allow-http-prod --quiet 2>/dev/null; then
          terraform import google_compute_firewall.allow_http projects/${{ secrets.GCP_PROJECT_ID }}/global/firewalls/allow-http-prod || true
        fi
        
        if gcloud compute firewall-rules describe allow-https-prod --quiet 2>/dev/null; then
          terraform import google_compute_firewall.allow_https projects/${{ secrets.GCP_PROJECT_ID }}/global/firewalls/allow-https-prod || true
        fi
        
        if gcloud compute firewall-rules describe allow-ssh-prod --quiet 2>/dev/null; then
          terraform import google_compute_firewall.allow_ssh projects/${{ secrets.GCP_PROJECT_ID }}/global/firewalls/allow-ssh-prod || true
        fi
        
        if gcloud compute firewall-rules describe allow-haproxy-lb-prod --quiet 2>/dev/null; then
          terraform import google_compute_firewall.allow_haproxy_lb projects/${{ secrets.GCP_PROJECT_ID }}/global/firewalls/allow-haproxy-lb-prod || true
        fi
        
        if gcloud compute firewall-rules describe allow-haproxy-web1-prod --quiet 2>/dev/null; then
          terraform import google_compute_firewall.allow_haproxy_web1 projects/${{ secrets.GCP_PROJECT_ID }}/global/firewalls/allow-haproxy-web1-prod || true
        fi
        
        if gcloud compute firewall-rules describe allow-haproxy-web2-prod --quiet 2>/dev/null; then
          terraform import google_compute_firewall.allow_haproxy_web2 projects/${{ secrets.GCP_PROJECT_ID }}/global/firewalls/allow-haproxy-web2-prod || true
        fi
        
        if gcloud compute firewall-rules describe allow-haproxy-stats-prod --quiet 2>/dev/null; then
          terraform import google_compute_firewall.allow_haproxy_stats projects/${{ secrets.GCP_PROJECT_ID }}/global/firewalls/allow-haproxy-stats-prod || true
        fi
        
        if gcloud compute firewall-rules describe allow-haproxy-stats-page-prod --quiet 2>/dev/null; then
          terraform import google_compute_firewall.allow_haproxy_stats_page projects/${{ secrets.GCP_PROJECT_ID }}/global/firewalls/allow-haproxy-stats-page-prod || true
        fi
        
        echo "‚úÖ Existing resources imported successfully"
        
    - name: Destroy infrastructure
      if: env.INFRA_EXISTS == 'true'
      run: |
        cd infrastructure
        export GOOGLE_APPLICATION_CREDENTIALS=/tmp/gcp-key.json
        export TF_VAR_project_id=${{ secrets.GCP_PROJECT_ID }}
        export TF_VAR_region=europe-west1
        export TF_VAR_zone=europe-west1-b
        export TF_VAR_environment=prod
        export TF_VAR_machine_type=e2-micro
        export TF_VAR_web_server_ips='["10.132.15.221", "10.132.15.222"]'
        export TF_VAR_haproxy_ip=10.132.15.223
        echo "üóëÔ∏è Destroying infrastructure using Terraform (preserving static IPs)..."
        echo "‚è±Ô∏è This will take ~30 seconds..."
        
        START_TIME=$(date +%s)
        
        # Destroy infrastructure using terraform with specific targets (preserve static IPs)
        terraform destroy -auto-approve \
          -var="project_id=${{ secrets.GCP_PROJECT_ID }}" \
          -var="region=europe-west1" \
          -var="zone=europe-west1-b" \
          -var="environment=prod" \
          -var="machine_type=e2-micro" \
          -var="web_server_ips=[\"10.132.15.221\", \"10.132.15.222\"]" \
          -var="haproxy_ip=10.132.15.223" \
          -target=google_compute_instance.haproxy \
          -target=google_compute_instance.web1 \
          -target=google_compute_instance.web2 \
          -target=google_compute_firewall.allow_http \
          -target=google_compute_firewall.allow_https \
          -target=google_compute_firewall.allow_ssh \
          -target=google_compute_firewall.allow_haproxy_lb \
          -target=google_compute_firewall.allow_haproxy_web1 \
          -target=google_compute_firewall.allow_haproxy_web2 \
          -target=google_compute_firewall.allow_haproxy_stats \
          -target=google_compute_firewall.allow_haproxy_stats_page || true
        
        END_TIME=$(date +%s)
        DESTROY_TIME=$((END_TIME - START_TIME))
        
        echo "‚è±Ô∏è Total destroy time: ${DESTROY_TIME} seconds"
        echo "‚úÖ Infrastructure destroyed successfully (static IPs preserved)"
        
    - name: Verify destruction
      run: |
        echo "üîç Verifying infrastructure destruction..."
        
        # Check if instances still exist
        INSTANCES_DESTROYED=true
        
        for instance in web1-prod web2-prod haproxy-prod; do
          if gcloud compute instances describe $instance --zone=europe-west1-b --quiet 2>/dev/null; then
            echo "‚ùå $instance still exists"
            INSTANCES_DESTROYED=false
          else
            echo "‚úÖ $instance destroyed"
          fi
        done
        
        if [ "$INSTANCES_DESTROYED" = "true" ]; then
          echo "üéâ All instances destroyed successfully!"
        else
          echo "‚ö†Ô∏è Some instances may still exist"
        fi
        
    - name: Display destruction results
      run: |
        echo "üí• Infrastructure Destruction Completed!"
        echo "======================================"
        echo ""
        
        if [ "$INFRA_EXISTS" = "false" ]; then
          echo "‚ÑπÔ∏è  No infrastructure was found to destroy"
          echo "   Nothing to do - infrastructure was already clean"
        else
          echo "‚úÖ DESTRUCTION STATUS: SUCCESS"
          echo "   All instances and resources have been destroyed"
          echo "   Static IP addresses have been preserved (prevent_destroy = true)"
        fi
        echo ""
        echo "üí∞ Cost Savings:"
        echo "   - VM instances: STOPPED/DESTROYED"
        echo "   - Compute costs: ELIMINATED"
        echo "   - Static IPs: PRESERVED (for future use)"
        echo ""
        echo "üîÑ To redeploy infrastructure:"
        echo "   - Go to Actions tab"
        echo "   - Run 'Deploy Infrastructure' workflow"
        echo "   - Or push to main/develop branch"
