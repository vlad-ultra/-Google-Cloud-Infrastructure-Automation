name: Deploy Infrastructure

on:
  push:
    branches: [ main, develop ]
  workflow_dispatch:  # Allow manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Google Cloud CLI
      uses: google-github-actions/setup-gcloud@v2
      with:
        service_account_key: ${{ secrets.GCP_SA_KEY }}
        project_id: ${{ secrets.GCP_PROJECT_ID }}
        export_default_credentials: true
        
    - name: Authenticate to Google Cloud
      run: |
        echo '${{ secrets.GCP_SA_KEY }}' > /tmp/gcp-key.json
        gcloud auth activate-service-account --key-file=/tmp/gcp-key.json
        gcloud config set project ${{ secrets.GCP_PROJECT_ID }}
        echo "GOOGLE_APPLICATION_CREDENTIALS=/tmp/gcp-key.json" >> $GITHUB_ENV
        
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.6.0
        
    - name: Initialize Terraform
      run: |
        cd infrastructure
        export GOOGLE_APPLICATION_CREDENTIALS=/tmp/gcp-key.json
        terraform init
        
    - name: Check existing infrastructure
      run: |
        cd infrastructure
        export GOOGLE_APPLICATION_CREDENTIALS=/tmp/gcp-key.json
        echo "üîç Checking for existing infrastructure..."
        
        # Check if instances exist
        if gcloud compute instances describe web1-prod --zone=europe-west1-b --quiet 2>/dev/null; then
          echo "‚úÖ Infrastructure already exists"
          echo "EXISTING_INFRA=true" >> $GITHUB_ENV
        else
          echo "üÜï No existing infrastructure found"
          echo "EXISTING_INFRA=false" >> $GITHUB_ENV
        fi
        
    - name: Import existing resources or Apply new
      run: |
        cd infrastructure
        export GOOGLE_APPLICATION_CREDENTIALS=/tmp/gcp-key.json
        if [ "$EXISTING_INFRA" = "true" ]; then
          echo "üîÑ Importing existing resources into Terraform state..."
          
          # Import static IPs if they exist
          if gcloud compute addresses describe web1-static-ip-prod --region=europe-west1 --quiet 2>/dev/null; then
            terraform import google_compute_address.web1_static_ip projects/${{ secrets.GCP_PROJECT_ID }}/regions/europe-west1/addresses/web1-static-ip-prod || true
          fi
          
          if gcloud compute addresses describe web2-static-ip-prod --region=europe-west1 --quiet 2>/dev/null; then
            terraform import google_compute_address.web2_static_ip projects/${{ secrets.GCP_PROJECT_ID }}/regions/europe-west1/addresses/web2-static-ip-prod || true
          fi
          
          if gcloud compute addresses describe haproxy-static-ip-prod --region=europe-west1 --quiet 2>/dev/null; then
            terraform import google_compute_address.haproxy_static_ip projects/${{ secrets.GCP_PROJECT_ID }}/regions/europe-west1/addresses/haproxy-static-ip-prod || true
          fi
          
          # Import internal IPs if they exist
          if gcloud compute addresses describe web1-internal-ip-prod --region=europe-west1 --quiet 2>/dev/null; then
            terraform import google_compute_address.web1_internal_ip projects/${{ secrets.GCP_PROJECT_ID }}/regions/europe-west1/addresses/web1-internal-ip-prod || true
          fi
          
          if gcloud compute addresses describe web2-internal-ip-prod --region=europe-west1 --quiet 2>/dev/null; then
            terraform import google_compute_address.web2_internal_ip projects/${{ secrets.GCP_PROJECT_ID }}/regions/europe-west1/addresses/web2-internal-ip-prod || true
          fi
          
          if gcloud compute addresses describe haproxy-internal-ip-prod --region=europe-west1 --quiet 2>/dev/null; then
            terraform import google_compute_address.haproxy_internal_ip projects/${{ secrets.GCP_PROJECT_ID }}/regions/europe-west1/addresses/haproxy-internal-ip-prod || true
          fi
          
          # Import instances if they exist
          if gcloud compute instances describe web1-prod --zone=europe-west1-b --quiet 2>/dev/null; then
            terraform import google_compute_instance.web1 projects/${{ secrets.GCP_PROJECT_ID }}/zones/europe-west1-b/instances/web1-prod || true
          fi
          
          if gcloud compute instances describe web2-prod --zone=europe-west1-b --quiet 2>/dev/null; then
            terraform import google_compute_instance.web2 projects/${{ secrets.GCP_PROJECT_ID }}/zones/europe-west1-b/instances/web2-prod || true
          fi
          
          if gcloud compute instances describe haproxy-prod --zone=europe-west1-b --quiet 2>/dev/null; then
            terraform import google_compute_instance.haproxy projects/${{ secrets.GCP_PROJECT_ID }}/zones/europe-west1-b/instances/haproxy-prod || true
          fi
          
          echo "‚úÖ Existing resources imported successfully"
        else
          echo "üÜï Applying new infrastructure..."
          terraform apply -auto-approve
        fi
        
    - name: Verify infrastructure status
      run: |
        cd infrastructure
        export GOOGLE_APPLICATION_CREDENTIALS=/tmp/gcp-key.json
        echo "üîç Verifying infrastructure status..."
        
        # Check if all instances are running
        INSTANCES_RUNNING=true
        
        for instance in web1-prod web2-prod haproxy-prod; do
          if ! gcloud compute instances describe $instance --zone=europe-west1-b --format="value(status)" | grep -q "RUNNING"; then
            echo "‚ùå $instance is not running"
            INSTANCES_RUNNING=false
          else
            echo "‚úÖ $instance is running"
          fi
        done
        
        if [ "$INSTANCES_RUNNING" = "true" ]; then
          echo "üéâ All infrastructure is running successfully!"
          echo "INFRA_STATUS=healthy" >> $GITHUB_ENV
        else
          echo "‚ö†Ô∏è Some instances are not running"
          echo "INFRA_STATUS=unhealthy" >> $GITHUB_ENV
        fi
        
    - name: Wait for instances to be ready
      run: |
        echo "‚è≥ Waiting for instances to be ready..."
        sleep 30
        
    - name: Apply content from web-apps
      run: |
        echo "üîÑ Applying content from web-apps/ directory..."
        
        # Function to update HTML content
        update_html_content() {
            local server_name=$1
            local html_file=$2
            local zone="europe-west1-b"
            
            echo "üìù Updating $server_name HTML content..."
            
            if [ ! -f "web-apps/$html_file" ]; then
                echo "‚ö†Ô∏è  web-apps/$html_file not found, skipping $server_name HTML update"
                return
            fi
            
            # Copy file to server
            echo "üì§ Uploading $html_file to $server_name..."
            gcloud compute scp "web-apps/$html_file" "$server_name:~/temp.html" --zone="$zone"
            
            # Apply changes on server
            gcloud compute ssh "$server_name" --zone="$zone" --command="
                echo 'üîÑ Applying HTML changes on $server_name...'
                
                # Backup current content
                sudo cp /var/www/html/index.html /var/www/html/index.html.backup.\$(date +%Y%m%d_%H%M%S) 2>/dev/null || true
                
                # Remove old content
                sudo rm -f /var/www/html/index.html
                sudo rm -f /var/www/html/index.html.*
                
                # Copy new content
                sudo cp ~/temp.html /var/www/html/index.html
                sudo chown root:root /var/www/html/index.html
                sudo chmod 644 /var/www/html/index.html
                
                # Clean up temp file
                rm -f ~/temp.html
                
                # Restart nginx to ensure changes take effect
                sudo systemctl restart nginx
                
                echo '‚úÖ $server_name HTML updated successfully'
            "
        }
        
        # Update web1 HTML
        update_html_content "web1-prod" "web1.html"
        
        # Update web2 HTML  
        update_html_content "web2-prod" "web2.html"
        
        # Update HAProxy dashboard
        update_html_content "haproxy-prod" "haproxy.html"
        
        # Update HAProxy configuration with current IPs
        echo "üìù Updating HAProxy configuration with current IPs..."
        WEB1_INTERNAL_IP="10.132.15.221"
        WEB2_INTERNAL_IP="10.132.15.222"
        
        gcloud compute ssh haproxy-prod --zone=europe-west1-b --command="
            echo 'üîÑ Updating HAProxy configuration...'
            
            # Backup current config
            sudo cp /etc/haproxy/haproxy.cfg /etc/haproxy/haproxy.cfg.backup.\$(date +%Y%m%d_%H%M%S)
            
            # Update backend IPs
            sudo sed -i 's/server web1 .*:80/server web1 $WEB1_INTERNAL_IP:80/' /etc/haproxy/haproxy.cfg
            sudo sed -i 's/server web2 .*:80/server web2 $WEB2_INTERNAL_IP:80/' /etc/haproxy/haproxy.cfg
            
            # Test configuration
            if sudo haproxy -c -f /etc/haproxy/haproxy.cfg; then
                sudo systemctl restart haproxy
                echo '‚úÖ HAProxy configuration updated and restarted'
            else
                echo '‚ùå HAProxy configuration test failed, restoring backup'
                sudo cp /etc/haproxy/haproxy.cfg.backup.* /etc/haproxy/haproxy.cfg
                sudo systemctl restart haproxy
            fi
        "
        
        echo "‚úÖ Content from web-apps/ applied successfully!"
        
    - name: Test deployment
      run: |
        echo "üß™ Testing deployment..."
        
        # Get HAProxy IP
        cd infrastructure
        export GOOGLE_APPLICATION_CREDENTIALS=/tmp/gcp-key.json
        HAPROXY_IP=$(terraform output -raw haproxy_external_ip)
        
        echo "üåê Testing Load Balancer..."
        LB_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" https://balancer.svdevops.tech -k || echo "000")
        if [ "$LB_RESPONSE" = "200" ]; then
            echo "‚úÖ Load Balancer working (200)"
            
            # Test load balancing - show web1-web2 alternation (fast)
            echo ""
            echo "üîÑ Testing Load Balancing (5 requests):"
            for i in {1..5}; do
                RESPONSE=$(curl -s https://balancer.svdevops.tech -k | grep -o "Web Server [12]" || echo "No response")
                echo "Request $i: $RESPONSE"
                sleep 0.2
            done
            echo "‚úÖ Load balancing test completed!"
        else
            echo "‚ö†Ô∏è  Load Balancer not ready yet ($LB_RESPONSE) - may need a few more seconds"
        fi
        
    - name: Display deployment info
      run: |
        echo "üéâ Deployment completed!"
        echo "======================="
        echo ""
        
        if [ "$INFRA_STATUS" = "healthy" ]; then
          echo "‚úÖ INFRASTRUCTURE STATUS: HEALTHY"
          echo "   All instances are running and ready"
        else
          echo "‚ö†Ô∏è  INFRASTRUCTURE STATUS: NEEDS ATTENTION"
          echo "   Some instances may not be running"
        fi
        echo ""
        
        echo "üåê URLs:"
        echo "   Load Balancer: https://balancer.svdevops.tech"
        echo "   Web1: https://web1.svdevops.tech"
        echo "   Web2: https://web2.svdevops.tech"
        echo "   Stats: http://$(cd infrastructure && export GOOGLE_APPLICATION_CREDENTIALS=/tmp/gcp-key.json && terraform output -raw haproxy_external_ip):8080/stats"
        echo ""
        echo "üí° All configurations are preserved from images:"
        echo "   ‚úÖ HAProxy with Let's Encrypt certificates"
        echo "   ‚úÖ Nginx with correct server_name"
        echo "   ‚úÖ Health checks enabled"
        echo "   ‚úÖ Load balancing configured"
        echo "   ‚úÖ Content from web-apps/ applied"
        echo ""
        echo "üîÑ Infrastructure Management:"
        echo "   - Existing resources were imported into Terraform state"
        echo "   - No duplicate resources created"
        echo "   - All services are operational"