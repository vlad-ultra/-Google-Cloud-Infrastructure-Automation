name: ğŸ§ª Test Infrastructure

on:
  workflow_dispatch:  # Manual trigger only
    inputs:
      test_type:
        description: 'Type of test to run'
        required: true
        default: 'connectivity'
        type: choice
        options:
        - connectivity
        - full
        - quick
      environment:
        description: 'Environment to test'
        required: true
        default: 'prod'
        type: choice
        options:
        - prod
        - staging

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Test configuration
      run: |
        echo "ğŸ§ª Starting infrastructure test..."
        echo "ğŸ“‹ Test type: ${{ github.event.inputs.test_type }}"
        echo "ğŸŒ Environment: ${{ github.event.inputs.environment }}"
        echo "â° Test started at: $(date)"
      
    - name: Setup Google Cloud CLI
      uses: google-github-actions/setup-gcloud@v2
      with:
        service_account_key: ${{ secrets.GCP_SA_KEY }}
        project_id: ${{ secrets.GCP_PROJECT_ID }}
        export_default_credentials: true
        
    - name: Authenticate to Google Cloud
      run: |
        echo '${{ secrets.GCP_SA_KEY }}' > /tmp/gcp-key.json
        gcloud auth activate-service-account --key-file=/tmp/gcp-key.json
        gcloud config set project ${{ secrets.GCP_PROJECT_ID }}
        echo "GOOGLE_APPLICATION_CREDENTIALS=/tmp/gcp-key.json" >> $GITHUB_ENV
        
    - name: Check infrastructure status
      run: |
        echo "ğŸ” Checking infrastructure status..."
        
        # Check if instances exist
        INSTANCES_FOUND=0
        INSTANCES_RUNNING=0
        
        for instance in web1-prod web2-prod haproxy-prod; do
          if gcloud compute instances describe $instance --zone=europe-west1-b --quiet 2>/dev/null; then
            echo "âœ… $instance exists"
            INSTANCES_FOUND=$((INSTANCES_FOUND + 1))
            
            # Check if running
            STATUS=$(gcloud compute instances describe $instance --zone=europe-west1-b --format="value(status)" 2>/dev/null)
            if [ "$STATUS" = "RUNNING" ]; then
              echo "   ğŸŸ¢ Status: RUNNING"
              INSTANCES_RUNNING=$((INSTANCES_RUNNING + 1))
            else
              echo "   ğŸ”´ Status: $STATUS"
            fi
          else
            echo "âŒ $instance not found"
          fi
        done
        
        echo "ğŸ“Š Summary:"
        echo "   - Instances found: $INSTANCES_FOUND/3"
        echo "   - Instances running: $INSTANCES_RUNNING/3"
        
        if [ $INSTANCES_FOUND -eq 0 ]; then
          echo "âš ï¸  No infrastructure found - run Deploy Infrastructure first"
          echo "INFRA_EXISTS=false" >> $GITHUB_ENV
        else
          echo "âœ… Infrastructure found"
          echo "INFRA_EXISTS=true" >> $GITHUB_ENV
        fi
        
        if [ $INSTANCES_RUNNING -eq 3 ]; then
          echo "âœ… All instances are running"
          echo "ALL_RUNNING=true" >> $GITHUB_ENV
        else
          echo "âš ï¸  Some instances are not running"
          echo "ALL_RUNNING=false" >> $GITHUB_ENV
        fi
        
    - name: Test connectivity
      if: env.INFRA_EXISTS == 'true' && env.ALL_RUNNING == 'true'
      run: |
        echo "ğŸŒ Testing connectivity..."
        
        # Get external IPs
        WEB1_IP=$(gcloud compute instances describe web1-prod --zone=europe-west1-b --format="value(networkInterfaces[0].accessConfigs[0].natIP)" 2>/dev/null)
        WEB2_IP=$(gcloud compute instances describe web2-prod --zone=europe-west1-b --format="value(networkInterfaces[0].accessConfigs[0].natIP)" 2>/dev/null)
        HAPROXY_IP=$(gcloud compute instances describe haproxy-prod --zone=europe-west1-b --format="value(networkInterfaces[0].accessConfigs[0].natIP)" 2>/dev/null)
        
        echo "ğŸ“ External IPs:"
        echo "   - Web1: $WEB1_IP"
        echo "   - Web2: $WEB2_IP"
        echo "   - HAProxy: $HAPROXY_IP"
        
        # Test HTTP connectivity
        echo "ğŸ”— Testing HTTP connectivity..."
        
        # Test Web1
        if curl -s --connect-timeout 10 --max-time 15 "http://$WEB1_IP" > /dev/null; then
          echo "âœ… Web1 HTTP: OK"
        else
          echo "âŒ Web1 HTTP: FAILED"
        fi
        
        # Test Web2
        if curl -s --connect-timeout 10 --max-time 15 "http://$WEB2_IP" > /dev/null; then
          echo "âœ… Web2 HTTP: OK"
        else
          echo "âŒ Web2 HTTP: FAILED"
        fi
        
        # Test HAProxy
        if curl -s --connect-timeout 10 --max-time 15 "http://$HAPROXY_IP" > /dev/null; then
          echo "âœ… HAProxy HTTP: OK"
        else
          echo "âŒ HAProxy HTTP: FAILED"
        fi
        
        # Test HTTPS connectivity
        echo "ğŸ”’ Testing HTTPS connectivity..."
        
        # Test Web1 HTTPS
        if curl -s --connect-timeout 10 --max-time 15 -k "https://$WEB1_IP" > /dev/null; then
          echo "âœ… Web1 HTTPS: OK"
        else
          echo "âŒ Web1 HTTPS: FAILED"
        fi
        
        # Test Web2 HTTPS
        if curl -s --connect-timeout 10 --max-time 15 -k "https://$WEB2_IP" > /dev/null; then
          echo "âœ… Web2 HTTPS: OK"
        else
          echo "âŒ Web2 HTTPS: FAILED"
        fi
        
        # Test HAProxy HTTPS
        if curl -s --connect-timeout 10 --max-time 15 -k "https://$HAPROXY_IP" > /dev/null; then
          echo "âœ… HAProxy HTTPS: OK"
        else
          echo "âŒ HAProxy HTTPS: FAILED"
        fi
        
    - name: Test load balancing
      if: env.INFRA_EXISTS == 'true' && env.ALL_RUNNING == 'true' && github.event.inputs.test_type != 'connectivity'
      run: |
        echo "âš–ï¸ Testing load balancing..."
        
        HAPROXY_IP=$(gcloud compute instances describe haproxy-prod --zone=europe-west1-b --format="value(networkInterfaces[0].accessConfigs[0].natIP)" 2>/dev/null)
        
        echo "ğŸ”„ Making 5 requests to test load balancing..."
        
        for i in {1..5}; do
          echo "Request $i:"
          RESPONSE=$(curl -s --connect-timeout 5 --max-time 10 "http://$HAPROXY_IP" 2>/dev/null || echo "No response")
          if [[ "$RESPONSE" == *"Web Server 1"* ]]; then
            echo "   â†’ Web1"
          elif [[ "$RESPONSE" == *"Web Server 2"* ]]; then
            echo "   â†’ Web2"
          else
            echo "   â†’ $RESPONSE"
          fi
          sleep 1
        done
        
    - name: Test domains
      if: env.INFRA_EXISTS == 'true' && env.ALL_RUNNING == 'true' && github.event.inputs.test_type == 'full'
      run: |
        echo "ğŸŒ Testing domain connectivity..."
        
        # Test domains
        DOMAINS=("balancer.svdevops.tech" "web1.svdevops.tech" "web2.svdevops.tech")
        
        for domain in "${DOMAINS[@]}"; do
          echo "Testing $domain..."
          
          # Test HTTP
          if curl -s --connect-timeout 10 --max-time 15 "http://$domain" > /dev/null; then
            echo "   âœ… HTTP: OK"
          else
            echo "   âŒ HTTP: FAILED"
          fi
          
          # Test HTTPS
          if curl -s --connect-timeout 10 --max-time 15 "https://$domain" > /dev/null; then
            echo "   âœ… HTTPS: OK"
          else
            echo "   âŒ HTTPS: FAILED"
          fi
        done
        
    - name: Display test results
      run: |
        echo "ğŸ“Š Test Results Summary"
        echo "======================"
        echo ""
        echo "â° Test completed at: $(date)"
        echo "ğŸ§ª Test type: ${{ github.event.inputs.test_type }}"
        echo "ğŸŒ Environment: ${{ github.event.inputs.environment }}"
        echo ""
        
        if [ "$INFRA_EXISTS" = "false" ]; then
          echo "âš ï¸  No infrastructure found"
          echo "   Run 'Deploy Infrastructure' workflow first"
        elif [ "$ALL_RUNNING" = "false" ]; then
          echo "âš ï¸  Infrastructure exists but not all instances are running"
          echo "   Check instance status in Google Cloud Console"
        else
          echo "âœ… Infrastructure is running and accessible"
          echo "   All tests completed successfully"
        fi
        
        echo ""
        echo "ğŸ”§ Available workflows:"
        echo "   - Deploy Infrastructure: Create/update infrastructure"
        echo "   - Remove GCP Deploy: Destroy infrastructure"
        echo "   - Test Infrastructure: This test workflow"
