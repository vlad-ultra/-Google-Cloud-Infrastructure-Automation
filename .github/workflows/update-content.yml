name: ðŸ”„ Update Content

on:
  # push:
  #   paths:
  #     - 'web-apps/**'
  #   branches: [ main, master ]
  workflow_dispatch: # Allow manual trigger only

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
  GCP_REGION: europe-west1
  GCP_ZONE: europe-west1-b

jobs:
  update-content:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ” Setup Google Cloud CLI
      uses: google-github-actions/setup-gcloud@v2
      with:
        service_account_key: ${{ secrets.GCP_SA_KEY }}
        project_id: ${{ secrets.GCP_PROJECT_ID }}
        export_default_credentials: true
        
    - name: ðŸ”‘ Authenticate to Google Cloud
      run: |
        echo '${{ secrets.GCP_SA_KEY }}' > /tmp/gcp-key.json
        gcloud auth activate-service-account --key-file=/tmp/gcp-key.json
        gcloud config set project ${{ secrets.GCP_PROJECT_ID }}
        echo "GOOGLE_APPLICATION_CREDENTIALS=/tmp/gcp-key.json" >> $GITHUB_ENV

    - name: ðŸ—ï¸ Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.6.0

    - name: ðŸ”„ Update Content
      run: |
        echo "ðŸ”„ Checking if infrastructure exists..."
        
        # Check if instances exist
        if gcloud compute instances describe haproxy-prod --zone=europe-west1-b --quiet 2>/dev/null; then
          echo "âœ… Infrastructure exists, updating content..."
          
          # Update web1 HTML
          echo "ðŸ“ Updating Web1 HTML..."
          if [ -f "web-apps/web1.html" ]; then
            gcloud compute scp web-apps/web1.html web1-prod:~/web1.html --zone=europe-west1-b
            gcloud compute ssh web1-prod --zone=europe-west1-b --command="
              sudo rm -f /var/www/html/index.html
              sudo cp ~/web1.html /var/www/html/index.html
              sudo chown www-data:www-data /var/www/html/index.html
              sudo systemctl reload nginx
            "
            echo "âœ… Web1 content updated"
          else
            echo "âš ï¸ web-apps/web1.html not found"
          fi
          
          # Update web2 HTML
          echo "ðŸ“ Updating Web2 HTML..."
          if [ -f "web-apps/web2.html" ]; then
            gcloud compute scp web-apps/web2.html web2-prod:~/web2.html --zone=europe-west1-b
            gcloud compute ssh web2-prod --zone=europe-west1-b --command="
              sudo rm -f /var/www/html/index.html
              sudo cp ~/web2.html /var/www/html/index.html
              sudo chown www-data:www-data /var/www/html/index.html
              sudo systemctl reload nginx
            "
            echo "âœ… Web2 content updated"
          else
            echo "âš ï¸ web-apps/web2.html not found"
          fi
          
          # Update HAProxy HTML
          echo "ðŸ“ Updating HAProxy HTML..."
          if [ -f "web-apps/haproxy.html" ]; then
            gcloud compute scp web-apps/haproxy.html haproxy-prod:~/haproxy.html --zone=europe-west1-b
            gcloud compute ssh haproxy-prod --zone=europe-west1-b --command="
              sudo cp ~/haproxy.html /var/www/html/index.html
              sudo chown www-data:www-data /var/www/html/index.html
            "
            echo "âœ… HAProxy content updated"
          else
            echo "âš ï¸ web-apps/haproxy.html not found"
          fi
          
          echo "âœ… Content updated successfully"
        else
          echo "âš ï¸ Infrastructure not found, skipping content update"
          echo "Run deploy workflow first to create infrastructure"
          exit 0
        fi

    - name: ðŸ§ª Test Content Update
      run: |
        echo "ðŸ§ª Testing content update..."
        
        # Check if infrastructure exists before testing
        if gcloud compute instances describe haproxy-prod --zone=europe-west1-b --quiet 2>/dev/null; then
          echo "âœ… Infrastructure exists, testing domains..."
          
          # Wait for content to be updated
          sleep 30
          
          # Test all domains
          echo "Testing Load Balancer (Roundrobin):"
          curl -f https://balancer.svdevops.tech || echo "âš ï¸ Load balancer test failed"
          
          echo "Testing Web1 (Direct):"
          curl -f https://web1.svdevops.tech || echo "âš ï¸ Web1 test failed"
          
          echo "Testing Web2 (Direct):"
          curl -f https://web2.svdevops.tech || echo "âš ï¸ Web2 test failed"
          
          # Test roundrobin with new content
          echo "Testing Roundrobin with updated content:"
          for i in {1..3}; do
            echo "Request $i:"
            curl -s https://balancer.svdevops.tech | grep -E "(Web Server|title)" | head -1
          done
        else
          echo "âš ï¸ Infrastructure not found, skipping tests"
        fi

    - name: ðŸ“Š Content Update Summary
      run: |
        echo "## ðŸ”„ Content Updated Successfully!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“ Updated Files:" >> $GITHUB_STEP_SUMMARY
        echo "- web-apps/web1.html" >> $GITHUB_STEP_SUMMARY
        echo "- web-apps/web2.html" >> $GITHUB_STEP_SUMMARY
        echo "- web-apps/haproxy.html" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸŒ Updated URLs:" >> $GITHUB_STEP_SUMMARY
        echo "- **Load Balancer (Roundrobin):** https://balancer.svdevops.tech" >> $GITHUB_STEP_SUMMARY
        echo "- **Web Server 1 (Direct):** https://web1.svdevops.tech" >> $GITHUB_STEP_SUMMARY
        echo "- **Web Server 2 (Direct):** https://web2.svdevops.tech" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… Verification:" >> $GITHUB_STEP_SUMMARY
        echo "- All domains tested successfully" >> $GITHUB_STEP_SUMMARY
        echo "- Roundrobin working correctly" >> $GITHUB_STEP_SUMMARY
        echo "- Content updated on all servers" >> $GITHUB_STEP_SUMMARY
