name: 🐛 Debug Authentication

on:
  workflow_dispatch: # Manual trigger only

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}

jobs:
  debug-auth:
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@v4

    - name: 🔍 Debug Environment
      run: |
        echo "🔍 Environment Debug:"
        echo "GITHUB_ACTIONS: $GITHUB_ACTIONS"
        echo "GCP_PROJECT_ID: ${GCP_PROJECT_ID:-'NOT SET'}"
        echo "GCP_SA_KEY length: ${#GCP_SA_KEY}"
        echo "GCP_SA_KEY first 50 chars: ${GCP_SA_KEY:0:50}..."
        echo ""
        echo "🔍 Available secrets:"
        echo "GITHUB_TOKEN: ${GITHUB_TOKEN:+Set}"
        echo "RUNNER_TEMP: $RUNNER_TEMP"
        echo "HOME: $HOME"

    - name: 🔐 Setup Google Cloud CLI (Method 1)
      uses: google-github-actions/setup-gcloud@v2
      with:
        service_account_key: ${{ secrets.GCP_SA_KEY }}
        project_id: ${{ secrets.GCP_PROJECT_ID }}
        export_default_credentials: true

    - name: 🧪 Test Method 1
      run: |
        echo "🧪 Testing Method 1 (google-github-actions):"
        echo "Account: $(gcloud auth list --filter=status:ACTIVE --format='value(account)' 2>/dev/null || echo 'None')"
        echo "Project: $(gcloud config get-value project 2>/dev/null || echo 'Not set')"
        echo "Services: $(gcloud services list --enabled --limit=3 2>/dev/null || echo 'Failed')"

    - name: 🔑 Manual Authentication (Method 2)
      run: |
        echo "🔑 Manual Authentication Method:"
        if [ -n "$GCP_SA_KEY" ]; then
          echo "Creating service account key file..."
          echo "$GCP_SA_KEY" > /tmp/gcp-key.json
          echo "Activating service account..."
          gcloud auth activate-service-account --key-file=/tmp/gcp-key.json
          echo "Setting project..."
          gcloud config set project "$GCP_PROJECT_ID"
          echo "Cleaning up..."
          rm -f /tmp/gcp-key.json
        else
          echo "❌ GCP_SA_KEY is not set!"
        fi

    - name: 🧪 Test Method 2
      run: |
        echo "🧪 Testing Method 2 (Manual):"
        echo "Account: $(gcloud auth list --filter=status:ACTIVE --format='value(account)' 2>/dev/null || echo 'None')"
        echo "Project: $(gcloud config get-value project 2>/dev/null || echo 'Not set')"
        echo "Services: $(gcloud services list --enabled --limit=3 2>/dev/null || echo 'Failed')"

    - name: 📊 Debug Summary
      run: |
        echo "## 🐛 Authentication Debug Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 🔍 Environment:" >> $GITHUB_STEP_SUMMARY
        echo "- GCP_PROJECT_ID: ${GCP_PROJECT_ID:-'NOT SET'}" >> $GITHUB_STEP_SUMMARY
        echo "- GCP_SA_KEY: ${GCP_SA_KEY:+Set (${#GCP_SA_KEY} chars)}${GCP_SA_KEY:-'NOT SET'}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 🔐 Authentication Status:" >> $GITHUB_STEP_SUMMARY
        echo "- Method 1 (google-github-actions): $(gcloud auth list --filter=status:ACTIVE --format='value(account)' 2>/dev/null || echo 'Failed')" >> $GITHUB_STEP_SUMMARY
        echo "- Method 2 (Manual): $(gcloud auth list --filter=status:ACTIVE --format='value(account)' 2>/dev/null || echo 'Failed')" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 🛠️ Next Steps:" >> $GITHUB_STEP_SUMMARY
        if [ -z "$GCP_PROJECT_ID" ] || [ -z "$GCP_SA_KEY" ]; then
          echo "- ❌ Check GitHub Secrets: Settings → Secrets and variables → Actions" >> $GITHUB_STEP_SUMMARY
        else
          echo "- ✅ Secrets are set, check authentication method" >> $GITHUB_STEP_SUMMARY
        fi
